<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Excel 图片处理</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      gap: 30px;
      padding: 30px;
    }
    .upload-area, .log-area {
      flex: 1;
    }
    .upload-area {
      padding: 20px;
      border: 2px dashed #ccc;
      border-radius: 10px;
    }
    .log-area {
      background: #1e1e1e;
      color: #00ff99;
      padding: 15px;
      height: 500px;
      overflow-y: auto;
      border-radius: 10px;
      font-family: monospace;
      white-space: pre-line;
    }
    button {
      margin-top: 10px;
      padding: 8px 20px;
    }
  </style>
</head>
<body>
  <div class="upload-area">
    <h2>📤 上传包含图片URL的Excel文件</h2>
    <form id="upload-form" enctype="multipart/form-data">
      <input type="file" name="file" accept=".xlsx" required /><br/>
      <button type="submit">上传并处理</button>
    </form>
    <div id="result" style="margin-top: 10px; font-weight: bold;"></div>
  </div>

  <div class="log-area" id="log-box">
    等待上传...
  </div>

  <script>
    const logBox = document.getElementById('log-box');
    async function fetchLogs() {
      try {
        const res = await fetch('/logs');
        const logs = await res.json();
        logBox.textContent = logs.join('\n') || "（暂无输出，请稍等...）";
      } catch (err) {
        logBox.textContent = "⚠️ 获取日志失败：" + err.message;
      }
    }
    setInterval(fetchLogs, 1000);

    document.getElementById('upload-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const resultDiv = document.getElementById('result');
      resultDiv.textContent = "处理中...";

      const formData = new FormData(this);
      try {
        const res = await fetch('/process', {
          method: 'POST',
          body: formData
        });

        if (!res.ok) throw new Error("状态码：" + res.status);

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = '图片预览结果.xlsx';
        document.body.appendChild(a);
        a.click();
        a.remove();
        resultDiv.textContent = "✅ 下载完成！";
      } catch (err) {
        resultDiv.textContent = "❌ 错误：" + err.message;
      }
    });
  </script>
</body>
</html>
